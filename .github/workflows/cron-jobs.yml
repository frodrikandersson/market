name: Scheduled Cron Jobs

on:
  schedule:
    # Fetch data every 30 minutes
    - cron: '*/30 * * * *'

    # Fetch stock prices every 2 minutes (60 stocks per run)
    - cron: '*/2 * * * *'

    # Backlog processor every 2 hours
    - cron: '0 */2 * * *'

    # Run predictions daily at 5 PM ET (10 PM UTC)
    - cron: '0 22 * * *'

    # Track predictions daily at 9:30 AM ET (2:30 PM UTC)
    - cron: '30 14 * * 1-5'  # Weekdays only

  # Allow manual triggering
  workflow_dispatch:
    inputs:
      job:
        description: 'Which job to run'
        required: true
        type: choice
        options:
          - fetch-data
          - fetch-prices
          - backlog-processor
          - run-predictions
          - track-predictions
          - auto-trader
          - all

jobs:
  fetch-data:
    runs-on: ubuntu-latest
    # Run every 30 minutes or when manually triggered
    if: github.event.schedule == '*/30 * * * *' || github.event.inputs.job == 'fetch-data' || github.event.inputs.job == 'all'

    steps:
      - name: Fetch Data
        run: |
          echo "Fetching data from all sources..."

          response=$(curl -s -w "\n%{http_code}" \
            "${{ secrets.APP_URL }}/api/cron/fetch-data?secret=${{ secrets.CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            exit 1
          fi

          echo "✓ Data fetch completed successfully"

  fetch-prices:
    runs-on: ubuntu-latest
    # Run every 2 minutes or when manually triggered
    if: github.event.schedule == '*/2 * * * *' || github.event.inputs.job == 'fetch-prices' || github.event.inputs.job == 'all'

    steps:
      - name: Fetch Stock Prices (Prioritized)
        run: |
          echo "Fetching stock prices for up to 60 companies (prioritized)..."

          response=$(curl -s -w "\n%{http_code}" -m 120 \
            "${{ secrets.APP_URL }}/api/cron/fetch-prices?secret=${{ secrets.CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            exit 1
          fi

          echo "✓ Stock prices updated successfully"

  backlog-processor:
    runs-on: ubuntu-latest
    # Run every 2 hours or when manually triggered
    if: github.event.schedule == '0 */2 * * *' || github.event.inputs.job == 'backlog-processor' || github.event.inputs.job == 'all'

    steps:
      - name: Process Backlog
        run: |
          echo "Processing backlog with AI..."

          response=$(curl -s -w "\n%{http_code}" -m 1800 \
            "${{ secrets.APP_URL }}/api/cron/backlog-processor?secret=${{ secrets.CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            exit 1
          fi

          echo "✓ Backlog processing completed successfully"

  run-predictions:
    runs-on: ubuntu-latest
    # Run daily at 5 PM ET or when manually triggered
    if: github.event.schedule == '0 22 * * *' || github.event.inputs.job == 'run-predictions' || github.event.inputs.job == 'all'

    steps:
      - name: Generate Predictions
        run: |
          echo "Generating daily predictions..."

          response=$(curl -s -w "\n%{http_code}" -m 300 \
            "${{ secrets.APP_URL }}/api/cron/run-predictions?secret=${{ secrets.CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            exit 1
          fi

          echo "✓ Predictions generated successfully"

  track-predictions:
    runs-on: ubuntu-latest
    # Run weekdays at 9:30 AM ET or when manually triggered
    if: github.event.schedule == '30 14 * * 1-5' || github.event.inputs.job == 'track-predictions' || github.event.inputs.job == 'all'

    steps:
      - name: Track Real-Time Predictions
        run: |
          echo "Tracking prediction accuracy..."

          response=$(curl -s -w "\n%{http_code}" -m 180 \
            "${{ secrets.APP_URL }}/api/cron/track-predictions?secret=${{ secrets.CRON_SECRET }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            exit 1
          fi

          echo "✓ Prediction tracking completed successfully"

  auto-trader:
    runs-on: ubuntu-latest
    # Run daily at 5:15 PM ET (after predictions are generated)
    if: github.event.schedule == '15 22 * * *' || github.event.inputs.job == 'auto-trader' || github.event.inputs.job == 'all'

    steps:
      - name: Execute Auto-Trading
        run: |
          echo "Executing AI auto-trading for all models..."

          response=$(curl -s -w "\n%{http_code}" -m 300 -X POST \
            "${{ secrets.APP_URL }}/api/auto-trader")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n-1)

          echo "Response: $body"

          if [ "$http_code" -ne 200 ]; then
            echo "Error: HTTP $http_code"
            exit 1
          fi

          echo "✓ Auto-trading completed successfully"
